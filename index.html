<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inicio Escolar</title>
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background-color: #334455;
  color: white;
}

nav {
  display: flex;
  justify-content: center;
  gap: 10px;
  padding: 10px;
  background-color: #0b2c56;
  position: sticky;
  top: 0;
}
nav a {
  text-decoration: none;
  background: #0d4a8c;
  color: white;
  padding: 10px 15px;
  border-radius: 10px;
  font-size: 14px;
  display: inline-block;
}
nav a:hover { background: #1565c0; }

.container {
  padding: 15px;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.card {
  background: #0d3d77;
  border-radius: 15px;
  padding: 15px;
}

.card h3 {
  margin: 0 0 10px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 18px;
}

.agenda-item {
  background: #1657a2;
  padding: 10px;
  border-radius: 10px;
  margin-bottom: 8px;
}

.grade {
  display: flex;
  align-items: center;
  gap: 10px;
  background: #1657a2;
  padding: 10px;
  border-radius: 10px;
  margin-bottom: 8px;
}

.circle {
  width: 35px;
  height: 35px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: bold;
  color: white;
}

.green { background: green; }
.yellow { background: orange; }
.red { background: red; }

.promedio-container { display:flex; gap:15px; flex-wrap:wrap; }
.promedio-container > div { border-radius:10px; padding:10px; }
.top3-item {
  background: #1657a2;
  padding: 12px;
  border-radius: 10px;
  display:flex;
  align-items:center;
  gap:10px;
  font-size:18px;
  font-weight:bold;
  color:white;
}
</style>
</head>
<body>
<nav>
  <a href="index.html">🏠 Inicio</a>
  <a href="agenda.html">📒 Agenda</a>
  <a href="calificacion.html">⭐ Calificación</a>
  <a href="asignaturas.html">🎓 Asignaturas</a>
  <a href="malla-curricular.html">📑 Malla Curricular</a>
</nav>

<div class="container">
  <div class="card">
    <h3>📒 Próximos eventos</h3>
    <div id="upcomingEvents"></div>
  </div>

  <div class="card">
    <h3>⭐ Últimas calificaciones <span id="promedio" style="margin-left:auto;">Promedio: 0,00</span></h3>
    <div id="ultimas-calificaciones"></div>
  </div>

  <div class="card promedio-container">
    <div style="flex:1 1 60%; background:#0d3d77;">
      <h3>📈 Promedio histórico</h3>
      <canvas id="graficoPromedio" height="150"></canvas>
    </div>
    <div style="flex:1 1 40%; display:flex; flex-direction:column;">
      <h3>🏅 Top 3 materias</h3>
      <div id="top3" style="display:flex; flex-direction:column; gap:10px;"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){

const months = ["ENE","FEB","MAR","ABR","MAY","JUN","JUL","AGO","SEP","OCT","NOV","DIC"];

const upcomingEvents = document.getElementById('upcomingEvents');

function renderUpcomingEvents() {
  upcomingEvents.innerHTML = '';
  const events = JSON.parse(localStorage.getItem('schoolEvents')) || [];
  const sortedEvents = events.sort((a,b)=> new Date(b.date)-new Date(a.date));
  const firstThree = sortedEvents.slice(0,3);

  if(firstThree.length===0){ upcomingEvents.innerHTML='<div class="agenda-item">No hay eventos próximos</div>'; return; }

  const today=new Date(); const tomorrow=new Date(today); tomorrow.setDate(today.getDate()+1);
  firstThree.forEach(event=>{
    const item=document.createElement('div'); item.classList.add('agenda-item');
    if(event.date) event.date=new Date(event.date);
    let dateLabel='';
    if(event.date.toDateString()===today.toDateString()) dateLabel='Hoy';
    else if(event.date.toDateString()===tomorrow.toDateString()) dateLabel='Mañana';
    else dateLabel=`${event.date.getDate()}/${months[event.date.getMonth()]}`;
    item.innerHTML=`${dateLabel} - ${event.subject} - <a href="${event.zoomLink}" target="_blank" style="color:#f0c300; text-decoration:underline;">Zoom</a>`;
    upcomingEvents.appendChild(item);
  });
}
renderUpcomingEvents();
window.addEventListener('storage',e=>{if(e.key==='schoolEvents') renderUpcomingEvents();});

// Últimas calificaciones
function colorNota(nota,sistema,minAprobado){
  nota=nota.toString().trim(); minAprobado=parseFloat(minAprobado);
  if(sistema==="1-10"){ nota=parseFloat(nota); if(nota<minAprobado-2) return "red"; if(nota>=minAprobado-2 && nota<minAprobado) return "yellow"; return "green"; }
  if(sistema==="0-100"){ nota=parseFloat(nota); if(nota<minAprobado-10) return "red"; if(nota>=minAprobado-10 && nota<minAprobado) return "yellow"; return "green"; }
  if(sistema==="0-1") return nota==="0"?"red":"green";
  if(sistema==="si-no") return nota.toLowerCase()==="no"?"red":"green";
  return "";
}

let calificaciones = JSON.parse(localStorage.getItem("calificaciones")||"[]");
calificaciones.sort((a,b)=> new Date(b.fecha)-new Date(a.fecha));
let ultimas5=calificaciones.slice(0,5);

const contenedor=document.getElementById("ultimas-calificaciones");
contenedor.innerHTML='';
let sumaTotal=0;
calificaciones.forEach(c=>{sumaTotal+=parseFloat(c.nota)||0;});

ultimas5.forEach(c=>{
  const div=document.createElement('div'); div.classList.add('grade');
  const circle=document.createElement('div'); circle.classList.add('circle',colorNota(c.nota,c.sistema,c.minAprobado)); circle.textContent=c.nota;
  const nombre=document.createElement('span'); nombre.textContent=c.materia; nombre.style.flexGrow="1"; nombre.style.textAlign="left";
  div.appendChild(circle); div.appendChild(nombre); contenedor.appendChild(div);
});

const promedio = calificaciones.length ? (sumaTotal/calificaciones.length).toFixed(2) : '0,00';
document.getElementById("promedio").textContent = `Promedio: ${promedio}`;

// Promedio histórico
const promediosPorMes = {};
calificaciones.forEach(c=>{
  const fecha=new Date(c.fecha);
  const key=`${fecha.getMonth()}-${fecha.getFullYear()}`;
  if(!promediosPorMes[key]) promediosPorMes[key]=[];
  promediosPorMes[key].push(parseFloat(c.nota)||0);
});
const labels = Object.keys(promediosPorMes).sort((a,b)=>{
  const [m1,y1]=a.split('-'); const [m2,y2]=b.split('-'); return new Date(y1,m1)-new Date(y2,m2);
});
const dataPromedios = labels.map(l=>{
  const notas=promediosPorMes[l];
  const sum=notas.reduce((a,b)=>a+b,0); return (sum/notas.length).toFixed(2);
});
const labelsText = labels.map(l=>{ const [m,y]=l.split('-'); return `${months[m]}/${y}`; });

const ctx=document.getElementById('graficoPromedio').getContext('2d');
new Chart(ctx,{
  type:'line',
  data:{ labels:labelsText, datasets:[{label:'Promedio', data:dataPromedios, borderColor:'white', backgroundColor:'rgba(255,255,255,0.2)', tension:0.3}]},
  options:{ plugins:{ legend:{ labels:{color:'white'} } }, scales:{ x:{ ticks:{ color:'white' }, grid:{ color:'rgba(255,255,255,0.2)'} }, y:{ ticks:{ color:'white' }, grid:{ color:'rgba(255,255,255,0.2)'} } } }
});

// Top 3 materias
const top3Container=document.getElementById('top3');
const promediosMaterias={};
calificaciones.forEach(c=>{ if(!promediosMaterias[c.materia]) promediosMaterias[c.materia]=[]; promediosMaterias[c.materia].push(parseFloat(c.nota)||0); });
const promediosArray = Object.entries(promediosMaterias).map(([mat,notas])=>{ const sum=notas.reduce((a,b)=>a+b,0); return {materia:mat,promedio:(sum/notas.length).toFixed(2)}; }).sort((a,b)=>b.promedio-a.promedio).slice(0,3);
const medallas=['🥇','🥈','🥉'];
top3Container.innerHTML='';
promediosArray.forEach((m,i)=>{
  const div=document.createElement('div'); div.className='top3-item';
  div.innerHTML=`${medallas[i]} ${m.materia} - ${m.promedio}`;
  top3Container.appendChild(div);
});

});
</script>
</body>
</html>
