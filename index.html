<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inicio Escolar</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    margin: 0;
    font-family: 'Arial', sans-serif;
    background-color: #2c3e50;
    color: white;
  }

  nav {
    display: flex;
    justify-content: center;
    gap: 10px;
    padding: 12px;
    background-color: #1a252f;
    position: sticky;
    top: 0;
    z-index: 100;
    flex-wrap: wrap;
  }
  nav a {
    text-decoration: none;
    background: #34495e;
    color: white;
    padding: 10px 15px;
    border-radius: 10px;
    font-size: 14px;
    transition: 0.2s;
  }
  nav a:hover { background: #1abc9c; }

  .container {
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .card {
    background: #34495e;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }

  .card h3 {
    margin: 0 0 15px;
    font-size: 22px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .agenda-item {
    background: #3a5f9f;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 10px;
    font-size: 14px;
  }

  .grade {
    display: flex;
    align-items: center;
    background: #3a5f9f;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 10px;
    font-size: 16px;
  }
  .circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    color: white;
    margin-right: 12px;
    font-size: 16px;
  }
  .green { background: #27ae60; }
  .yellow { background: #f39c12; }
  .red { background: #c0392b; }

  .promedio-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
  }
  .promedio-container > div {
    flex: 1 1 45%;
    background: #34495e;
    border-radius: 15px;
    padding: 15px;
  }
  #top3 .top-item {
    display: flex;
    align-items: center;
    gap: 12px;
    background: #3a5f9f;
    padding: 12px;
    border-radius: 10px;
    font-size: 16px;
  }

  @media(max-width: 768px){
    .promedio-container {
      flex-direction: column;
    }
    .promedio-container > div {
      flex: 1 1 100%;
    }
    .circle {
      width: 35px;
      height: 35px;
      font-size: 14px;
    }
    nav a {
      flex: 1 1 45%;
      text-align: center;
      margin-bottom: 5px;
    }
  }
</style>
</head>
<body>

<nav>
  <a href="index.html">🏠 Inicio</a>
  <a href="agenda.html">📒 Agenda</a>
  <a href="calificacion.html">⭐ Calificación</a>
  <a href="asignaturas.html">🎓 Asignaturas</a>
  <a href="malla-curricular.html">📑 Malla Curricular</a>
</nav>

<div class="container">

  <div class="card">
    <h3>📒 Próximos eventos</h3>
    <div id="upcomingEvents"></div>
  </div>

  <div class="card">
    <h3>⭐ Últimas calificaciones <span id="promedio" style="margin-left:auto;">Promedio: 0,00</span></h3>
    <div id="ultimas-calificaciones"></div>
  </div>

  <div class="card promedio-container">
    <div>
      <h3>📈 Promedio histórico</h3>
      <canvas id="graficoPromedio" height="120"></canvas>
    </div>
    <div>
      <h3>🏅 Top 3 materias</h3>
      <div id="top3"></div>
    </div>
  </div>

</div>

<script>
// --- Próximos eventos ---
const upcomingEvents = document.getElementById('upcomingEvents');
function renderUpcomingEvents() {
  upcomingEvents.innerHTML = '';
  const events = JSON.parse(localStorage.getItem('schoolEvents')) || [];
  const sorted = events.sort((a,b)=> new Date(a.date) - new Date(b.date)).slice(0,3);
  if(!sorted.length) { upcomingEvents.innerHTML = '<div class="agenda-item">No hay eventos próximos</div>'; return; }
  const today = new Date(), tomorrow = new Date(); tomorrow.setDate(today.getDate()+1);
  sorted.forEach(e=>{
    const div = document.createElement('div');
    div.classList.add('agenda-item');
    const date = new Date(e.date);
    let label = date.toDateString() === today.toDateString() ? 'Hoy' : date.toDateString() === tomorrow.toDateString() ? 'Mañana' : `${date.getDate()}/${date.getMonth()+1}`;
    div.innerHTML = `${label} - ${e.subject} - <a href="${e.zoomLink}" target="_blank" style="color:#f0c300;">Zoom</a>`;
    upcomingEvents.appendChild(div);
  });
}
renderUpcomingEvents();
window.addEventListener('storage', e => { if(e.key==='schoolEvents') renderUpcomingEvents(); });

// --- Últimas calificaciones ---
function colorNota(nota){ nota=parseFloat(nota); if(nota>=7) return 'green'; if(nota>=4) return 'yellow'; return 'red'; }
const ultimasCalifCont = document.getElementById('ultimas-calificaciones');
let calificaciones = JSON.parse(localStorage.getItem('calificaciones')||"[]");
calificaciones.sort((a,b)=> new Date(b.fecha)-new Date(a.fecha));
const ultimas5 = calificaciones.slice(0,5);
ultimasCalifCont.innerHTML='';
let suma = 0;
ultimas5.forEach(c=>{
  suma+=parseFloat(c.nota)||0;
  const div = document.createElement('div'); div.classList.add('grade');
  const circle = document.createElement('div'); circle.className='circle '+colorNota(c.nota); circle.textContent=c.nota;
  const nombre = document.createElement('span'); nombre.textContent=c.materia;
  div.appendChild(circle); div.appendChild(nombre);
  ultimasCalifCont.appendChild(div);
});
document.getElementById('promedio').textContent = calificaciones.length ? 'Promedio: '+(calificaciones.reduce((a,b)=>a+parseFloat(b.nota||0),0)/calificaciones.length).toFixed(2) : 'Promedio: 0,00';

// --- Promedio histórico gráfico ---
const ctx = document.getElementById('graficoPromedio').getContext('2d');
let meses = {};
calificaciones.forEach(c=>{
  const d = new Date(c.fecha);
  const key = `${d.getMonth()+1}/${d.getFullYear()}`;
  if(!meses[key]) meses[key]=[]; meses[key].push(parseFloat(c.nota)||0);
});
const labels = Object.keys(meses);
const data = labels.map(l=> (meses[l].reduce((a,b)=>a+b,0)/meses[l].length).toFixed(2));
new Chart(ctx, {
  type:'line',
  data:{
    labels,
    datasets:[{
      label:'Promedio',
      data,
      borderColor:'#f1c40f',
      backgroundColor:'rgba(241,196,15,0.2)',
      tension:0.3,
      fill:true,
      pointBackgroundColor:'#f1c40f'
    }]
  },
  options:{
    plugins:{ legend:{ labels:{ color:'white' } } },
    scales:{
      x:{ ticks:{ color:'white' } },
      y:{ ticks:{ color:'white' } }
    }
  }
});

// --- Top 3 materias ---
const top3Cont = document.getElementById('top3');
let promedios = {};
calificaciones.forEach(c=>{
  if(!promedios[c.materia]) promedios[c.materia]=[]; promedios[c.materia].push(parseFloat(c.nota)||0);
});
let sorted = Object.entries(promedios).map(([m,notas])=>({materia:m,prom: (notas.reduce((a,b)=>a+b,0)/notas.length).toFixed(2)}));
sorted.sort((a,b)=>b.prom-a.prom);
top3Cont.innerHTML='';
['🥇','🥈','🥉'].forEach((emoji,i)=>{
  if(sorted[i]){
    const div = document.createElement('div'); div.classList.add('top-item');
    div.innerHTML=`${emoji} ${sorted[i].materia} - ${sorted[i].prom}`;
    top3Cont.appendChild(div);
  }
});
</script>

</body>
</html>
